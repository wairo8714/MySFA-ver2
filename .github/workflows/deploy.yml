name: Deploy to AWS

on:
  push:
    branches: [ main, bugfix, feature ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: Setup SSH with debugging
        run: |
          # SSHéµã‚’ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # SSHéµã®å†…å®¹ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          echo "ğŸ” SSHéµã®å†…å®¹ç¢ºèª:"
          head -1 ~/.ssh/id_rsa
          tail -1 ~/.ssh/id_rsa
          echo "ğŸ“ SSHéµã®è¡Œæ•°:"
          wc -l ~/.ssh/id_rsa
          
          # SSHéµã®å½¢å¼ã‚’ç¢ºèª
          echo "ğŸ” SSHéµã®å½¢å¼ç¢ºèª:"
          ssh-keygen -y -f ~/.ssh/id_rsa | head -1

      - name: Add EC2 to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH connection with enhanced debugging
        run: |
          echo "ğŸŒ æ¥ç¶šå…ˆ: ${{ secrets.EC2_HOST }}"
          echo "ğŸ‘¤ SSHãƒ¦ãƒ¼ã‚¶ãƒ¼: ec2-user"
          echo "ğŸ“¡ GitHub Actions Runnerã®IP:"
          curl -s http://checkip.amazonaws.com || echo "IPå–å¾—å¤±æ•—"
          
          # SSHæ¥ç¶šãƒ†ã‚¹ãƒˆ
          ssh -v -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} "echo 'SSH connection successful'" || {
            echo "âŒ SSHæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "ğŸ” known_hostsã®å†…å®¹:"
            cat ~/.ssh/known_hosts || echo "known_hostsãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ğŸ—ï¸ SSHéµã®å­˜åœ¨ç¢ºèª:"
            ls -la ~/.ssh/id_rsa || echo "SSHéµãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ğŸ” SSHéµã®æ¨©é™ç¢ºèª:"
            ls -la ~/.ssh/ | grep id_rsa || echo "SSHéµã®æ¨©é™ç¢ºèªå¤±æ•—"
            exit 1
          }

      - name: Deploy to EC2
        run: |
          set -x
          echo "Starting deployment to EC2..."

          echo "Uploading files..."
          scp -v -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa -r src/ ec2-user@${{ secrets.EC2_HOST }}:/home/ec2-user/ || { echo "SCPå¤±æ•—"; exit 1; }
          echo "File upload completed"

          echo "Uploading Dockerfile..."
          scp -v -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa docker/Dockerfile ec2-user@${{ secrets.EC2_HOST }}:/home/ec2-user/ || { echo "Dockerfile uploadå¤±æ•—"; exit 1; }
          echo "Dockerfile upload completed"

          echo "Building Docker image..."
          ssh -v -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} "cd /home/ec2-user && sudo docker build -t mysfa-app ." || { echo "Docker buildå¤±æ•—"; exit 1; }
          echo "Docker build completed"

          echo "Starting MySQL container..."
          ssh -v -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} "sudo docker stop mysfa-db || true && sudo docker rm mysfa-db || true && sudo docker run -d --name mysfa-db -e MYSQL_ROOT_PASSWORD=ic8DNPgaIV9_drROsdUzsKxejTI -e MYSQL_DATABASE=mysfa_db -e MYSQL_USER=admin -e MYSQL_PASSWORD=0LmJtwp2V5Y3HyJa9y0YGPjJxC0 -p 3306:3306 mysql:8.0" || { echo "MySQL container startå¤±æ•—"; exit 1; }
          echo "MySQL container started"

          echo "Waiting for MySQL to be ready..."
          sleep 30

          echo "Restarting Docker container..."
          ssh -v -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} "sudo docker stop mysfa-app || true && sudo docker rm mysfa-app || true && sudo docker run -d --name mysfa-app -p 8000:8000 -e ALLOWED_HOSTS=${{ secrets.EC2_HOST }},mysfa.net mysfa-app" || { echo "Container restartå¤±æ•—"; exit 1; }
          echo "Container restart completed"

          echo "Performing health check..."
          sleep 10
          curl -v -f https://mysfa.net || { echo "Deployment completed but health check failed"; exit 1; }
          echo "Deployment completed successfully!"